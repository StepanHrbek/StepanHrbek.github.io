<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
 <SCRIPT language="javascript" type="text/javascript">
  <!--
  if(parent.document.body) parent.document.body.rows="0,*";
  //-->
 </SCRIPT>
 <META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=iso-8859-2">
 <TITLE>Digital reconstruction of cartoon movies</TITLE>
 <LINK rel="stylesheet" type="text/css" href="../default.css">
</HEAD>
<BODY background="../bricks.jpg" style="margin-left:140px">

<table width=100%><tr style="background-color:#cccccc">
 <th><a href="../index.html">Home</a></th>
 <th><a href="../sw/index.html">Software</a></th>
 <th><a href="../texty/index.html">Articles</a></th>
 <th><a href="http://fotnicek.dee.cz">Photos</a></th>
</tr></table>
<p>

 <h2>Digital reconstruction of cartoon movies based on genetic algorithms</h2>

 <img src="0000.png"><p>

 <table width="100%" bgcolor=#cccccc><td>What is done</td></table>
 <ul>
 <li>module1: tracking / camera movement detection [genetic algorithm]
 <li>module2: fixing brightness fluctuations between frames [genetic algorithm]
 <li>module3: removing dust and scratches [static algorithm]
 <li>module4: building large static backgrounds from multiple frames [static algorithm]
 </ul>

 <p>
 <table width="100%" bgcolor=#cccccc><td>Contact</td></table>
 <ul>
 <li><a href="http://dee.cz">Lab's of Dee</a>
 <li>dee at dee.cz
 </ul>

 <img src="0014.png"><p>

 <table width="100%" bgcolor=#cccccc><td>Paper on module2, Czech only preview (2002)</td></table>
 <pre>

Vyrovnání globálního kolísání jasu v sekvencích obrázkù

Úvod/Abstrakt

V sekvencích obrázkù se mohou z rùzných dùvodù objevovat ne¾ádoucí 
globální fluktuace jasu. Proto¾e informace potøebná k jejich detekci 
a odstranìní le¾í v srovnání jasù tých¾ objektù na rùzných snímcích,
s vyu¾itím nezávislé komponenty sledování pohybu budeme porovnávat
histogramy oblastí z obou snímkù, které obsahují stejné objekty.
Transformaci jasu zkonstruujeme s pomocí genetického algoritmu
jako splajn nejlépe odpovídající námi zvoleným kritériím.



Vyrovnávání jasu

Konstrukce jasové transformace 

Globální transformaci jasu (kde jas je reálné èíslo 0..1) definujeme jako neklesající 
funkci tl:R->R procházející body [0,0] a [1,1].
Jasovou transformací Tl:snímek->snímek pak rozumíme nahrazení v¹ech pixelù 
s jasem j pixelem odpovídající barvy s jasem tl(j). Barevnou slo¾kou snímkù se 
dále nezabýváme, pracujeme pouze s jasem.
Ne¾ádoucí globální transformace jasu se kterými se mù¾eme v praxi setkat
jsou velmi rùznorodé, jednoduchá gamma korekce není dostateèným opravným
prostøedkem.
Chceme pou¾ít co nejrobustnìj¹í funkci schopnou postihnout co nejvíce zmìn jasu,
ke kterým mù¾e napøíklad pøi tvorbì filmu, degradaci filmového matriálu 
a digitalizaci filmu dojít,
u které ale pùjde (v pøípadì, ¾e oèekáváme pouze jednoduché transformace)
snadno regulovat urèitá míra hladkosti a jednoduchosti.
f tedy budeme reprezentovat jako splajn procházející
nìkolika body, z nich¾ pouze krajní [0,0] a [1,1] jsou pevné. 
Zbylé body najde genetický
algoritmus tak, aby maximalizoval optimalitu transformace (viz kritéria
optimality ní¾e).

V na¹í implementaci jsme pou¾ili Fritsch-Carlsonùv splajn, nicménì i
jiné splajny dávaly srovnatelné výsledky.
Jako optimální poèet bodù, kterými splajn prochází,
se v pøípadì animovaného filmu Rumcajs ukázalo èíslo pìt (tj. tøi pohyblivé).

Kritéria optimality

Popí¹eme tøi schémata umo¾òující posoudit kvalitu jasové transformace Tl.

-Porovnání histogramù snímkù Fa a Tl(Fb)

Jako jednoduché kritérium optimality transformace Tl je mo¾né brát podobnost
histogramù Fa a Tl(Fb). Porovnání vychází z oèekávání, ¾e ve filmových sekvencích
vìt¹inou del¹í dobu zùstávají v zábìru stejné objekty, které mohou v histogramu
celého snímku produkovat zøetelné lokální extrémy. Pøi vhodnì navr¾eném
kritériu podobnosti histogramù by pak genetický algoritmus mohl nacházet
transformace, které nejlépe mapují jeden histogram do tvarù podobných
druhému histogramu. Bohu¾el v praxi se obsah sousedních snímkù a jejich
histogramy relativnì èasto mìní takovým zpùsobem
(do zábìru vstupují nové objekty, jiné mizí), ¾e pouze z histogramù 
celých snímkù není mo¾né vhodnou transformaci jasu urèit. 
Tuto cestu jsme tedy opustili.

-Porovnání histogramù jednotlivých objektù nalezených v Tg(Fa) i Tl(Fb)

Problémy pøedchozí metody je mo¾né odstranit nalezením a 
porovnáním pouze objektù nalezených v obou snímcích.
Pokud se objekty smr¹»ují nebo rozpínají (vzdalují nebo pøibli¾ují),
je nezbytné provést s nimi takové geometrické transformace Tg, abychom
porovnávali pixel jednoho objektu proti pixelu druhého objektu.
Vzhledem k výpoèetní nároènosti vyhledávání objektù v obou snímcích
je vhodné nehledat objekty znovu pro ka¾dou novou transformaci jasu, ale pouze
jednou na zaèátku výpoètu 
a do kritéria podobnosti objektù v Tg(Fa) a Fb pøitom zahrnout podobnost
jejich textur po odeètení jejich prùmìrného jasu (zùstane informce témìø 
nezávislá na zatím neznámé mo¾né zmìnì jasu).
Toto kritérium by bylo vhodné pro obecný filmový materiál.

-Porovnání histrogramù prùniku Tg(Fa) a Tl(Fb)

Primárním cílem této práce bylo vyøe¹it zadaný problém
pro konkrétní pøípad animovaných veèerníèkù Rumcajs.
Obraz v nich bývá slo¾en témìø výhradnì z dvourozmìrného statického pozadí a
po nìm se pohybujících plochých postavièek, které vìt¹inou zabírají pouze
malou èást zábìru.
To umo¾òuje pou¾ít jednodu¹¹í a efektivnìjí schéma porovnávání vhodné pouze pro 
podobná zadání.
Pro celý výpoèet jasové transformace nejprve jednou s vyu¾itím 
nezávisle vyvíjené komponenty
sledování pohybu kamery najdeme geometrickou transformaci Tg snímku Fa,
po které budeme moci porovnávat pixel snímku Tg(Fa) proti korespondujícímu 
pixelu snímku Fb.
Následnì u¾ pracujeme pouze s èástí Tg(Fa) a èástí Fb, které si obsahem
odpovídají. Kritériem optimality jasové transformace Tl se pak stane
rozdílnost histogramù Tg(Fa) a Tl(Fb) (genetický algoritmus se ji
sna¾í minimalizovat) definovaná jako
 SUM[i=0..255] abs( Tl(Fb).hist[i]-Tg(Fa).hist[i] )
(F.hist[i] znaèí poèet pixelù s jasem i ve snímku F) 
a dále zahrnující následující modifikace.

Vyhlazení histogramù

U dostateènì velkých obrázkù nemá náhodný ¹um v texturách vliv 
na podobnost histogramù. Ov¹em
pøi na¹ich geometrických transformacích dochází ke zmìnì charakteristik textur
a ¹umu, pøi bilineární interpolaci jsou extrémní jasy v textuøe
interpolovány s jasy sousedních pixelù s neextrémními jasy,
tak¾e textura transformovaného snímku obsahuje u¾¹í spektrum hodnot jasu.
Následné mìøení podobnosti histogramù usnadní vyhlazení histogramù
- taková transformace histogramù, po které budou histogramy pùvodního 
snímku i transformovaného snímku s redukovaným ¹umem opìt podobné.
Vyhlazování implementujeme jako iteraèní proces, ve kterém pro ka¾dé j
malou èást poètu pixelù s jasem j histo[j] pøesuneme do histo[j-1] a histo[j+1].
Krok opakujeme dokud pomìr SUM histo[j]-(histo[j-1]+histo[j+1])/2 
k poètu zpracovávaných pixelù pøekraèuje zadanou míru hrubosti histogramu
(pro histogram o 256 prvcích nad obrázky v TV rozli¹ení se osvìdèilo 0.01).

Zvýraznìní minoritních extrémù v histogramu

V del¹ích pásmech jasù,
které se ve snímcích Tg(Fa) a Fb témìø nevyskytují (neobydlená pásma),
by mohly být i zcela chybné transformace pova¾ovány za správné
a ojedinìlé pixely daných jasù by byly nesprávnì transformovány.
Proto po vyhlazení transformujeme histogramy tak,
aby byly nízké lokální extrémy zvýraznìny 
a vysoké potlaèeny - hist[i] nahradíme výrazem 
(log(hist[i]+100)-log(100))*1000.
Uvedená transformace pomáhá najít takovou transformaci, která i drobný lokální 
extrém v neobydleném pásmu namapuje na korespondující extrém v druhém histogramu.

Preference jednoduché transformace

Pokud se v neobydleném pásmu nevyskytují ¾ádné vhodné lokální extrémy,
kterými by se optimalizaèní proces øídil, nelze o prùbìhu transformaèní
funkce rozhodnout. Oprávnìnì v¹ak lze oèekávat, ¾e správná transformace
je ve vìt¹inì pøípadu spí¹e jednoduchá hladká køivka s minimem inflexních bodù.
Do kritéria optimality tedy zahrneme penaltu 
  abs(tl(i-1)+tl(i+1)-2*tl(i)) / (Tg(Fa).hist[i]+Tl(Fb).hist[i]+10) * 2000000 pro i=0..255 
penalizující "klikatost" køivky a podporující její "hladkost" v neobydlených
pásmech (èitatel vyjadøuje klikatost, jmenovatel obydlenost).

Pásmo tolerovaného ¹umu

Pokud se korespondující pixely porovnávaných snímkù Tg(Fa) a Tl(Fb)
(Tl je zde dosud nejlep¹í nalezená jasová transformace, na zaèátku výpoètu identita)
výraznì li¹í (abs(p1-p2)>DELTA), témìø jistì le¾í v oblasti, kde se snímky li¹í.
Takové pixely nezahrnujeme do porovnávání snímkù (do histogramù).
V pøípadì, ¾e rozdíl není velký (abs(p1-p2)<=DELTA), mohou pixely le¾et
v pro nás podstatné oblasti, kde se snímky svým obsahem shodují; odchylka
pak bývá zpùsobena pouze drobnými nepøesnostni Tg a ¹umem v textuøe,
který jsme se rozhodli je¹tì tolerovat.

Zu¾ování pásma tolerovaného ¹umu

Pøi stanovení ¹íøky pásma ¹umu (DELTA) hrají roli dva faktory. Chceme aby program dokázal 
zdetekovat co nejvìt¹í transformace jasu (napø. zmìnu jasu 100/255 na 150/255,
chceme vysoké DELTA).
Zároveò chceme, aby program rozeznal oblasti, kde se snímky li¹í,
a nezahrnul je do výpoètu místo toho aby vyrovnával jas tak aby se podobaly
(chceme nízké DELTA).
Na zaèátku výpoètu tedy nastavíme vysoké DELTA (50) a po urèitých poètech 
generací genetického algoritmu ho sni¾ujeme a¾ na hodnoty kolem 10.
Zu¾ování pásma postupnì omezuje prostor v kterém se mohou úspì¹nì
pohybovat alternativní jasové transformace generované genetickým algoritmem,
pásmo se poka¾dé zú¾í kolem dosud nejlep¹í nalezené jasové transformace.
Pro zvý¹ení efektivity výpoètu nepracujeme v¾dy s celými snímky ale
pouze s jejich histogramy, které pøi ka¾dé zmìnì DELTA aktualizujeme.

Vyu¾ití pixelù mimo tolerovaný ¹um

V situaci, kdy zcela ignorujeme pixely Tg(Fa) a Tl(Fb), které spolu
nekorespondují, tj. do výpoètu není zahrnut objekt pohybující se nad
statickým pozadím, napø. jediný tmavý objekt nad jinak svìtlým pozadím,
se mù¾e stát, ¾e pro histogramy ztratíme rozhodující oblasti palety,
¹iroká pásma histogramù zùstanou neobydlená.
Kritérium optimality transformace by pak vùbec nezahrnovalo jak transformovat
jas tmavého pohybujícího se objektu. Proto paralelnì s histogramy
respektujícími pásmo tolerovaného ¹umu pracujeme i s histogramy
zahrnujícími i pixely pøekraèující toleranci. Výsledky zji¹tìné nad tìmito
histogramy se stávájí souèástí výsledného kritéria optimality s vahou 0.33
(výsledky zji¹tìné nad dosud popisovanými histogramy obsahujícími pouze 
pixely z pásma tolerovaného ¹umu mají váhu 0.67).

Zpracování sekvence

Sekvence je posloupnost snímkù F1 a¾ FN taková, ¾e mezi snímáním Fn
a Fn+1 nedo¹lo k výraznému pohybu nebo zoomu kamery a oba snímky
obsahují podobné objekty v popøedí i podobné pozadí.
Ná¹ systém postupnì vyrovnává jas snímkù F2 a¾ FN s referenèním snímkem Fref.
Referenèním snímkem se na zaèátku výpoètu stává snímek F1.
V pøípadì, ¾e spoleèná èást snímkù Fref a Fn má pøíli¹ malý prùnik
(kamera se napø. posunula o polovinu ¹íøky snímku)
a n>ref+1, novým referenèním snímkem se stane Fn-1, u kterého jsme jas ji¾ vyrovnali.
V pøípadì, ¾e spoleèná èást snímkù Fref a Fn má pøíli¹ malý prùnik
a n=ref+1, mezi snímky Fn-1 a Fn jsme nalezli rozhraní sekvencí.



Budoucí práce

Zámìrné pomalé zmìny jasu

V situaci kdy objekt náhle zøetelnì zmìní jas nevzniká ¾ádná komplikace,
vý¹e popsaný optimalizaèní postup nebere náhle zmìnìný objekt v potaz
a vygeneruje korektní transformaèní funkci.
Pokud je ale zámìrná zmìna jasu pomalá, systém zmìnu mù¾e eliminovat jako chybu.
Pøi hledání transformace jasu snímku F(n+k) vùèi referenènímu snímku Fn
systém zcela eliminuje zmìnu jasu pro malá k, tj. tøeba pro snímky
Fn+1 a¾ Fn+15. Snímek Fn+16 a dal¹í u¾ ale obsahují natolik odli¹ný jas,
¾e je pova¾ován za zámìrnou zmìnu a není korigován vùbec.
V sekvenci, která je výstupem programu,
pak zámìrná plynulá zmìna jasu zaène a¾ o 16 snímkù pozdìji a to skokem.
V souèasné implementaci není problém o¹etøen.

Pohyb nad ¹irokou scénou

Pokud kamera v jednom zábìru odjede do strany o n ¹íøek snímku,
zpracování celé sekvence si vy¾ádá minimálnì 2*n zmìn referenèního snímku.
Proto¾e jas celé sekvence pøizpùsobujeme jasu prvního snímku,
vy¾ádá si korekce jasu posledního snímku
slo¾ení minimálnì 2*n nezávisle detekovaných jasových transformací
(k poslednímu snímku vzdálenému
o n*¹íøka_snímku se dostaneme pøes minimálnì 2*n referenèních snímkù vzdálených 
v¾dy nejvý¹e o ¹íøka_snímku/2).
V¹echny drobné chyby jasových transformací se skládáním násobí,
tak¾e pro rostoucí n bude výsledek divergovat.
V takových situacích by bylo provizorním øe¹ením zpracovat sekvenci 
nezávisle po men¹ích èástech.
                 
Související komponenty

Celý implementovaný systém nyní zahrnuje tyto komponenty
-subpixelové sledování pohybu kamery (pravo-levo, nahoru-dolù, zoom,
 roz¹iøitelné na obecnìj¹í transformaci)
 optimalizované pro Rumcajse, se spolehlivostí zatím kolem 90-95%,
 vy¾aduje dal¹í vývoj
-zde popsané vyrovnávání jasu v sekvencích, optimalizované pro Rumcajse
 ale pravdìpodobnì bez zásahù vhodné i pro jiné animované filmy,
 pro obecný obrazový materiál pou¾itelné pouze s vyspìlou komponentou 
 sledování pohybu 
-velmi kvalitní eliminace
 kolem 95% ¹krábancù a prachu zalo¾ená na podobnosti sousedních snímkù
 v animovaném Rumcajsovi
-skládání spoleèného pozadí ze sekvencí obrázkù
 eliminující z pozadí kromì zhruba 99% ¹krábancù a prachu i vìt¹í èást popøedí,
 sekání spoleèného pozadí na pozadí jednotlivých snímkù
Neinteraktivní systém je mo¾né dále vyvíjet a roz¹íøit o interakci,
která by umo¾nila ruèní korekce chyb zejména v komponentì sledování pohybu kamery.



Závìr

Popsali jsme systém vyrovnávající jas v sekvencích
obrázkù a implememtovali jeho verzi optimalizovanou pro korekce jasu ve starých
animovaných filmech.
Systém je plnì automatický, neinteraktivní, nicménì nezávislá komponenta
detekce pohybu vy¾aduje pøed nasazením v praxi dal¹í výzkum,
pøípadnì mo¾nost interaktivního opravování chyb systému.
Pøechod na obecný filmový materiál je mo¾ný
s dostateènì vyspìlou komponentou sledování pohybu.

 </pre>

</BODY>
</HTML>
